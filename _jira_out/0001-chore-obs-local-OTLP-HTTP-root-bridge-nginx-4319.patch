From 8d663b4669abf3a7a649e618ad800ae124364004 Mon Sep 17 00:00:00 2001
From: Gustavo Schneiter <gmhschn@gmail.com>
Date: Fri, 19 Sep 2025 01:33:36 -0300
Subject: [PATCH] chore(obs): local OTLP HTTP root bridge (nginx, 4319)

---
 docker-compose.bridge.yml  | 20 ++++++++++++++++++++
 ops/nginx/otlp-bridge.conf | 21 +++++++++++++++++++++
 2 files changed, 41 insertions(+)
 create mode 100644 docker-compose.bridge.yml
 create mode 100644 ops/nginx/otlp-bridge.conf

diff --git a/docker-compose.bridge.yml b/docker-compose.bridge.yml
new file mode 100644
index 0000000..3797993
--- /dev/null
+++ b/docker-compose.bridge.yml
@@ -0,0 +1,20 @@
+services:
+  otlp-bridge:
+    image: nginx:1.25-alpine
+    volumes:
+      - ./ops/nginx/otlp-bridge.conf:/etc/nginx/conf.d/default.conf:ro
+    ports:
+      - "4319:4319"
+    depends_on:
+      - otel-collector
+    restart: unless-stopped
+
+  otlp-metrics-bridge:
+    image: nginx:1.25-alpine
+    volumes:
+      - ./ops/nginx/otlp-metrics.conf:/etc/nginx/conf.d/default.conf:ro
+    ports:
+      - "4320:4320"
+    depends_on:
+      - otel-collector
+    restart: unless-stopped
diff --git a/ops/nginx/otlp-bridge.conf b/ops/nginx/otlp-bridge.conf
new file mode 100644
index 0000000..a68510f
--- /dev/null
+++ b/ops/nginx/otlp-bridge.conf
@@ -0,0 +1,21 @@
+server {
+  listen 4319;
+  client_max_body_size 20m;
+
+  # POST na raiz â†’ reescreve para /v1/traces sem redirecionar
+  location = / {
+    rewrite ^ /v1/traces break;
+    proxy_pass http://otel-collector:4318;
+    proxy_set_header Host $host;
+    proxy_set_header X-Forwarded-For $remote_addr;
+    proxy_http_version 1.1;
+  }
+
+  # Encaminha /v1/traces normalmente
+  location /v1/traces {
+    proxy_pass http://otel-collector:4318;
+    proxy_set_header Host $host;
+    proxy_set_header X-Forwarded-For $remote_addr;
+    proxy_http_version 1.1;
+  }
+}
-- 
2.50.1

